- name: Test preparation
  hosts: migrator
  tasks:
  - ansible.builtin.import_tasks: common/prep.yml
- name: Make sure conversion hosts are cleaned up
  ansible.builtin.import_playbook: "{{ lookup('env', 'OS_MIGRATE') }}/playbooks/delete_conversion_hosts.yml"
- name: Deploy conversion hosts
  ansible.builtin.import_playbook: "{{ lookup('env', 'OS_MIGRATE') }}/playbooks/deploy_conversion_hosts.yml"
- name: Conversion host inventory
  hosts: migrator
  tasks:
  - ansible.builtin.include_role:
      name: os_migrate.os_migrate.conversion_host
      tasks_from: conv_hosts_inventory.yml

# Immediately unregister the conversion hosts to prevent dangling
# subscriptions from CI in case the job crashes.
- name: Unregister conversion hosts
  hosts: conversion_hosts
  ignore_unreachable: true
  tasks:
  - ansible.builtin.include_role:
      name: os_migrate.os_migrate.conversion_host
      tasks_from: unregister.yml

- name: Migration tests
  hosts: migrator
  tasks:
  - args:
      apply:
        tags:
        - test_clean_before
        - test_workload
        - test_image_workload_boot_copy
        - test_image_workload_boot_nocopy
    tags: always
    ansible.builtin.include_tasks: tenant/clean_workload.yml
  - args:
      apply:
        tags:
        - test_clean_before
        - test_pre_workload
    tags: always

    # pre-workload seed & migrate
    ansible.builtin.include_tasks: tenant/clean_pre_workload.yml
  - args:
      apply:
        tags: test_pre_workload
    tags: always
    ansible.builtin.include_tasks: tenant/seed_pre_workload.yml
  - args:
      apply:
        tags: test_pre_workload
    tags: always

    # server from image with attached volume
    # migration w/o boot volume copy
    ansible.builtin.include_tasks: tenant/run_pre_workload.yml
  - args:
      apply:
        tags:
        - test_workload
        - test_image_workload_boot_nocopy
    tags: always
    ansible.builtin.include_tasks: tenant/seed_workload.yml
  - args:
      apply:
        tags:
        - test_workload
        - test_image_workload_boot_nocopy
    tags: always
    ansible.builtin.include_tasks: tenant/run_workload.yml
  - args:
      apply:
        tags:
        - test_workload
        - test_image_workload_boot_nocopy
        - test_image_workload_boot_nocopy_clean
    tags: always

    # server from image with attached volume
    # migration with boot volume copy
    ansible.builtin.include_tasks: tenant/clean_workload.yml
  - args:
      apply:
        tags:
        - test_workload
        - test_image_workload_boot_copy
    tags: always
    ansible.builtin.include_tasks: tenant/seed_workload.yml
  - args:
      apply:
        tags:
        - test_workload
        - test_image_workload_boot_copy
    tags: always
    vars:
      set_boot_volume_copy: true
    ansible.builtin.include_tasks: tenant/run_workload.yml
  - args:
      apply:
        tags:
        - test_clean_after
        - test_workload
        - test_image_workload_boot_copy
        - test_image_workload_boot_copy_clean
    tags: always

    # pre-workload cleanup
    ansible.builtin.include_tasks: tenant/clean_workload.yml
  - args:
      apply:
        tags:
        - test_clean_after
        - test_pre_workload
    tags: always
    ansible.builtin.include_tasks: tenant/clean_pre_workload.yml
  tags:
  - test_migration

- name: Delete conversion hosts
  when: test_clean_conversion_hosts_after|default(true)|bool
  ansible.builtin.import_playbook: "{{ lookup('env', 'OS_MIGRATE') }}/playbooks/delete_conversion_hosts.yml"
