# FIXME: Find a way we can test the whole playbook rather than just
# the role. Either make sure we're not in a play here and use
# import_playbook, or spawn an ansible-playbook subprocess? The latter
# might be actually a more precise way to test the real end-user
# experience.

- name: User tasks
  block:
    - include_role:
        name: os_migrate.os_migrate.export_users
      vars:
        # This expression should export all osm_ workloads
        # skipping the universal conversion host (osm_uch)
        # which is used to move the VM's.
        # We create it on in seed.yml but we dont export it.
        os_migrate_user_filter:
          - regex: '^osm_(?!uch)'

    - name: load exported data
      set_fact:
        resources: "{{ (lookup('file',
                               os_migrate_data_dir +
                               '/users.yml') | from_yaml)
                       ['resources'] }}"

    - name: verify data contents
      assert:
        that:
          - (resources |
            json_query("[?params.name ==
            'osm_user'].params.name")
            == ['osm_user'])

    - include_role:
        name: os_migrate.os_migrate.import_users
  tags: always
